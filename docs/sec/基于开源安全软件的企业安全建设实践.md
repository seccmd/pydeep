**目录**

[TOC]



## TODO
Istio

eBPF

Sandbox

- https://chromium.googlesource.com/chromium/src/+/HEAD/docs/design/sandbox.md

- https://www.hysolate.com/learn/sandboxing/sandboxing-isolating-apps-browsers-malicious-software/
  https://www.lambdatest.com/blog/browser-sandboxing/
  https://www.browserling.com/
- https://sandboxie-plus.com/


## DONE

- 2023-07-16：完成 Falco.md 编程和测试
- 2023-07-15：完成文章大纲和文字部分编写，文字构思很久，设计内容笔记庞大，不急于发布和完美，小步快跑自己先对自己有价值。

## 一、前言

安全的根本目的是保证组织可持续运行，不论从合规监管要求，还是频发的数据泄露事件、再到不择手段的网络加密勒索导致的业务停摆，企业面临的网络安全压力越来越大。从另外一个角度看，企业也面临着竞争和发展问题，所以需要精打细算，控制成本。

信息安全、网络安全、数据安全综合起来是一个庞大安全体系，因为攻击者会无孔不入，企业任何一块儿短板都可能是攻击者的跳板。但是，安全体系也不是一天建设完成的，需要从外到内、抓重点保核心，分阶段分步骤实施。

除了大型高利润企业，一般的企业投入的安全成本有限，但是面临的风险却并不少。对于中小企业或初创公司，开源安全软件能够非常低成本地有效解决安全防护问题。但是又出现了新的问题，面对各式各样的开源安全软件很难做出合理选择。

所以，笔者希望构建一套《基于开源软件的企业安全建设方案》，把我十多年的安全建设经历和思考进行梳理和总结，帮助处于成长期的企业低成本解决安全风险，避免由于网络安全问题导致企业发展受阻，等到企业有足够的体量和能力后再逐步增加安全投入。



## 二、企业面临的风险与挑战

### 2.1 企业安全威胁与挑战

- 网络攻击可造成重大损失，据埃森哲估算，2019 年全球因网络攻击造成的经济损失约 2.5 万亿美元，是2018年的1.6 倍；到2025年预计达到 5.2 万亿美元。Gartner 数据也显示2019年66%的企业遭到黑客攻击，54%企业至少被黑客攻击一次或多次。
- 网络监管单位对信息技术安全提出了更严格的监管要求，国家级网络实战攻防演习逐渐形成趋势，以验证国家关键基础设施及重要业务系统的实战化攻防能力，已经基本形成了标准的、规模化的网络安全检查形式。 
- 攻击意图更具野心一旦被攻破影响巨大，在针对重要目标攻击时，前期周密准备和复杂的策略，并进行长期潜伏与持续渗透，达到转移资金、窃取机密、篡改数据、中断业务，瘫痪关键基础设施，甚至是更为致命的目的。 
- 攻击手法越来越高级化和多样化，包括后门、APT攻击、0Day漏洞利用、定制化恶意代码，以及社会工程学等。攻击范围从关键基础设施到IoT设备，从PC端到移动端，都无一例外的成为黑客瞄准的目标对象。 
- 攻击防御难度骤增攻击威胁无孔不入，绕过现有防御措施，长期隐藏在网络中，已经是攻击者的“常规操作”，应对攻击者所发起的高频度、大规模、高级别的网络攻击，没有什么防护手段可以一劳永逸一招制敌，任何疏忽大意都可能给黑客提供可乘之机。 

### 2.2 企业主要安全需求

- 业务中断瘫痪风险（DDoS、勒索病毒、蠕虫病毒、恶意操作）
- 业务监管合规风险（管理责任、处罚罚款、停业整顿、吊销证照）
- 企业网络入侵风险（网络犯罪、竞争对手、APT）
- 企业数据安全风险（商业机密、用户数据、数据擦除、数据泄露）
- 客户侧业务风险（盗号撞库、异常注册、异常登录、灰产薅羊毛、客户端防护）

### 2.3 企业安全体系建设划为5大模块

1. **安全治理与合规（满足网安法等保、数安法、个保法的基本要求）**
     - 公安部等级保护定级备案测评
              1. 安全管理（管理责任、安全负责人、安全管理制度）
              2. 安全技术（建立安全防护和监控措施，重要数据备份和加密，日志审计6个月）
     - 工信部App隐私保护
     - ISO27001
     - 上市IT审计

2. **网络安全（网络安全法为指导）**
   - 办公网安全 BeyondCorp - EDR AV DLP VPN 网络准入 AD
   - 生产网安全 BeyondProd FW IDS WAF 扫描器 微服务 服务鉴权 容器隔离
   - 研发和运维安全 DevSecOps 黑盒 白盒 灰盒 威胁建模 人工审计

3. **数据安全（数据安全法为指导）**
   - 数据资产梳理，分类分级（财务信息、人力信息、经营数据、交易订单数据）
   - 数据安全风险评估（重要性、脆弱性、威胁、防护方案）（传输、存储、使用）
   - 数据安全防护和监控（身份认证、访问权限、加密、脱敏、审计）

4. **用户安全（个人信息保护法为指导）**
   - 隐私保护政策
   - 客户明确同意收集的信息
   - 禁止违法收集信息
   - 禁止违法使用、售卖个人信息
   - 个人信息变更和销毁的功能

5. **安全运营（不断提升持续迭代能力，实战经验积累）**
      1. 安全中心运营 SOC （资产管理、事件管理、漏洞管理等）
      2. 应急预案和响应（系统漏洞、病毒木马、网络攻击、网络入侵）
      3. 安全意识培训，员工入职在职离职等流程安全



## 三、基于开源软件的企业安全建设实践

### 3.1 开源安全架构设计

首先我们要模拟一个公司的网络环境，然后在这个网络拓扑基础上，构建我们的安全系统。下图就是模拟一个信息系统部署在云上的典型的网络拓扑，其中包括：云区域和办公区域两大部分组成。云区域再细分为边界防护区、安全管理区和核心业务区，办公区分为固定办公地点和移动办公两种形式。图中的每个框线都代表了一个安全域，每个安全域又又不同的安全等级，每个安全域的边界都需要进行保护，区域之间的访问或数据流动都应该访问控制策略和安全检测机制，尤其是核心重点区域。

![网络安全架构图](基于开源安全软件的企业安全建设实践/网络安全架构图-1689418809448-10.png)

图中涉及的安全系统有边界区（防火墙、DDoS 流量防护、Web 防护、入侵检测），办公区（病毒查杀、终端安全、防泄漏、零信任），内网区（安全运营中心、身份安全、主机安全、堡垒机、扫描器）。针对这些安全系统，下面我们会对每一项分别展开进行讨论。



## 四、探索发现好项目的能力

#### 开源安全项目排行榜

- [Open Source Security Index](https://opensourcesecurityindex.io/)

- CNCF 中的安全项目

- hashicorp

- http://stepyun.com/

- https://github.com/icopy-site/awesome-cn/blob/master/docs/awesome/awesome-security.md

- https://asmcn.icopy.site/awesome/awesome-malware-analysis/

- 牛逼的开源项目组合 - todo专项调研
   https://projectdiscovery.io/#/

   多个牛逼产品
   github\.com/projectdiscovery

- 大量的Payload 拓展知识边界

  - https://swisskyrepo.github.io/PayloadsAllTheThings/#sponsors


#### 效率生产力准备

每个重点安全系统 准备一个镜像，便于需要时调试

#### 资源准备

1人 1电脑



## 五、开源安全产品技术方案

k8s AD Kerberos LDAP CA

MOA SSO EDR DLP 准入

### HIDS

Kubeeye - Tool To Find Various Problems On Kubernetes - https://www.kitploit.com/2022/11/kubeeye-tool-to-find-various-problems.html

linux反弹shell

反弹Shell原理及检测技术研究

- https://www.cnblogs.com/LittleHann/p/12038070.html

- https://www.cnblogs.com/LittleHann/p/12322437.html

  DLP https://github.com/bytedance/godlp

https://github.com/elastic/protections-artifacts

**Falco**

- https://falco.org/

**ossec osquery**

**YARA**

- https://github.com/VirusTotal/yara

- https://virustotal.github.io/yara/

**clamAV**

- https://github.com/bytedance/AgentSmith-HIDS

 OpenEDR

- https://github.com/ComodoSecurity/openedr
- https://github.com/Mr-Un1k0d3r/EDRs

 Advanced File Analysis System

- https://valkyrie.comodo.com/ 



### Scanner

 https://github.com/j3ssie/Osmedeus

**rengine**

- https://rengine.wiki/
- https://blog.intigriti.com/2021/08/24/hacker-tools-rengine/

**Nuclei**

- Fast and customizable vulnerability scanner based on simple YAML based DSL.
- https://github.com/projectdiscovery/nuclei

**OSV-Scanner：最佳开源代码扫描器**

- OSV提供了更广泛的漏洞来源和语言，被视为DevOps团队的替代性开源扫描工具，至少是补充性开源扫描工具。

**ZAP OWASP**

- https://owasp.org/www-project-zap/

**Wapiti**

- [Wapiti : a Free and Open-Source web-application vulnerability scanner in Python (wapiti-scanner.github.io)](https://wapiti-scanner.github.io/)

- 一些测试表明，Wapiti比ZAP等其他开源工具检测出更多的SQLi和Blind SQLi漏洞。

**OpenSCAP：最适合注重合规的扫描**

**OpenVAS：最适合端点和网络扫描**



### WAF

[六款免费 WAF 的测试报告 (qq.com)](https://mp.weixin.qq.com/s?__biz=MzIzOTE1ODczMg==&mid=2247497147&idx=1&sn=491b953ad08b9cf52ed4aa072716d19d&chksm=e92ce118de5b680e95e801b67b80639d750ca9bb3f035f8c86b0625833ad5c3098afa5560527&scene=58&subscene=0#rd)

**Safeline**

- https://github.com/chaitin/safeline
- https://mp.weixin.qq.com/s/pbddfl5T_NDPFZE39pZKPQ

**Curiefense**

- https://www.curiefense.io/

**ModSecurity**

- https://github.com/SpiderLabs/ModSecurity-nginx 

- 安装过程：https://anjia0532.github.io/2017/07/19/openresty/



### SOC

**Security Onion 2**

- https://securityonionsolutions.com/software

- 安全洋葱（Security Onion）是一个免费的开源平台，用于网络、主机和企业安全监控和日志管理（收集和后续分析）。

  凭借可用的软件包集合，Security Onion为高需求的事件响应和取证用例提供了一个最佳的、高度可扩展的解决方案。

  安全洋葱有丰富的数据收集，安全分析，数据分析和可视化组件。它包括TheHive、Playbook、Fleet、osquery、CyberChef、Elasticsearch、Logstash、Kibana、Suricata、Zeek、Wazuh和许多其他工具。

- **Static Analysis (PCAP and EVTX Import)**  Spin up a virtual machine quickly and get started in just a few minutes.

- **SOC Workstation** 

- 介绍：[网络入侵检测开源项目 Security Onion-FancyPig's blog (iculture.cc)](https://www.iculture.cc/cybersecurity/pig=18998)

**Sigma** 目前看没有太大价值

- https://github.com/SigmaHQ/sigma

**Wazuh**

- [Wazuh 4.1 documentation](https://documentation.wazuh.com/current/installation-guide/open-distro/all-in-one-deployment/unattended-installation.html)



### Newwork

- Zeek**（以前称为Bro）**

### IAM

- Keycloak
- APISIX + Open Policy Agent



### Other

**Kubernetes 安全防护**

- https://www.redhat.com/zh/topics/containers/kubernetes-security

**配置文件加密**

Node
https://www.npmjs.com/package/jasypt

Java
https://www.cnblogs.com/kexianting/p/11689289.html

Searchable Encryption

https://zhuanlan.zhihu.com/p/135382555
https://blog.csdn.net/A33280000f/article/details/116270371

vault

https://developer.hashicorp.com/vault



### SDP

**开源方案**

sdp fwknop waverleylabs

https://sourceforge.net/software/compare/Waverley-Labs-SDP-vs-Zentry-vs-Zscaler/

https://info.support.huawei.com/info-finder/encyclopedia/zh/%E9%9B%B6%E4%BF%A1%E4%BB%BB.html

**Demo**

```
开源SDP 软件定义边界环境的安装和搭建
https://blog.csdn.net/caoli4608/article/details/122603419

OpenSDP - GitHub Pages
opensdp.github.io/
https://www.deepcloudsdp.com/product.html#architecture
https://geekflare.com/software-defined-perimeter-solutions/

网络打通
oauth proxy
http knock client
http knock server

基于浏览器的SDP：目的 通过浏览器模拟，实现软件SDP功能，极大降低成本。

浏览器 长连接 到 网关，保持会话状态。
客户端 可以部署或者不部署软件。 安全能力强弱，监听端口 类似美团的安全浏览器。
网关 通过 oauth认证iam身份，代理到后端服务。
网关 通过 oauth认证iam蛇粉，代理一个自研服务，这个服务用于打开端口 控制iptable。
IP信任打通，或者证书 信任。进行放行。

无客户端/HttpSDP
sdp 开发者中心？
通过http api，可以集成一个 SDP零信任网关。提升效率、没有客户端问题。 控制器集成。
```

**基于软件定义边界（SDP）的零信任**

```
IAM只能在登录环节/过期环节，才能判断用户IP/网络/地域/设备，是否发生了变化，然后触发多因素。
IAM缺乏客户端侧 和 服务端测 的监控能力，无法做到实时 自适应验证。

常见的三种零信任方案 https://zhuanlan.zhihu.com/p/414957427
零信任架构的3大核心技术 https://blog.csdn.net/yutao929/article/details/113625306
基于零信任的三大原则，常见的零信任方案分为三种：
基于身份治理的零信任
基于微隔离的零信任
基于软件定义边界（SDP）的零信任

零信任三大技术之SDP https://www.cnblogs.com/Dreamboat1218/p/14451846.html

SDP概述
SDP Software Defined Perimeter（软件定义边界），2013 年由云安全联盟 CSA提出。
SDP 设计基本原则
1、信息隐身：隐藏服务器地址、端口，使之不被扫描发现
2、预认证：在连接服务器之前，先认证用户和设备的合法性
3、预授权：用户只能看到被授权访问的应用（最小权限原则）
4、应用级的访问准入：用户只有应用层的访问权限，无网络级的准入
5、扩展性：基于标准协议，可以方便与其他安全系统集成


SDP三大组件
SDP控制器：SDP的大脑，主要进行主机认证和策略下发，还可以用于认证和授权SDP连接发起主机、配置到SDP连接接受主机的连接。
SDP连接发起主机：终端用户设备或者可以被称为SDP客户端
SDP连接接受主机：SDP网关或者边界
注：为了文章可读以及比较容易理解，后面的SDP连接发起主机（IH）我将采用SDP客户端来代替，使用SDP网关来代替SDP连接接受主机（AH）

1、SDP 控制器确定哪些SDP客户端和SDP网关可以相互通信。SDP控制器可以将信息中继到外部认证服务，例如认证地理位置和/或身份服务器。
2、SDP客户端与SDP控制器通信用来请求它们可以连接哪些SDP网关列表。在提供信息之前SDP控制器可以向 SDP客户端请求硬件或软件之类的信息。
3、默认情况下SDP网关拒绝来自SDP控制器以外的所有主机的所有通信。只有在SDP控制器下发指令后，SDP网关才接受来自SDP客户端的连接。


SDP 主要功能
基础设施隐藏：终端用户设备在通过身份验证授权之前，SDP控制器和SDP网关不会响应任何连接请求。
减少Dos攻击：面向互联网的服务都处于SDP网关的后面，可以抵挡DOS攻击，SPA可以保护SDP网关免受DOS攻击。
检测错误包：从任何其他主机到SDP客户端的第一个数据包是SPA 数据包（或类似的安全构造)。如果SDP网关收到任何其他数据包，则将其视为攻击。
防止越权访问网络：设备只能访问策略允许的特定主机和服务，不能越权访问网段和子网。
应用程序和服务访问控制：SDP 控制允许哪些设备和应用程序可访问特定服务例如应用程序和系统服务。
注：SPA：单包授权，使未授权的用户和设备无法感知或访问。

 
SDP架构图

SDP工作流程
1、一个或多个 SDP 控制器上线并连接到身份验证和授权服务，例如 AM、 PKI 服务、设备验证、地理位置、SAML、 OpenID、OAuth、LDAP、Kerberos、多因子身份验证、身份联盟和其他类似的服务。
2、一个或者多个SDP网关上线。它们以安全的方式连接SDP控制器并进行验证。SDP网关不响应来自任何其他主机的通信，也不会响应任何未许可的请求。
3、每个SDP客户端会与SDP 控制器连接并进行身份验证。(单包第一次）
4、SDP客户端被验证之后，SDP 控制器确定终端用户设备被授权可以连接的SDP网关列表。（可以连哪些SDP网关）
5、SDP 控制器告知SDP网关接受来自SDP客户端的通信，并启动加密通信所需的任何可选策略。
6、SDP 控制器给SDP客户端提供SDP网关列表，以及加密通信所需的任何可选策略。
7、SDP客户端向每个授权的SDP网关发起SPA，然后SDP客户端和这些SDP网关创建双向加密连接（双向TLS认证）。（单包第二次）
8、SDP客户端通过SDP网关并使用双向加密的数据信道与资源通信。
```



## 数据安全方案储备

Golddigger - Search Files For Gold
 https://www.kitploit.com/2023/06/golddigger-search-files-for-gold.html
 https://github.com/josehelps/git-wild-hunt



## 系统安全方法储备

**Procmon-for-Linux**

- https://github.com/Sysinternals/Procmon-for-Linux

- [GitHub - Sysinternals/ProcMon-for-Linux: Procmon is a Linux reimagining of the classic Procmon tool from the Sysinternals suite of tools for Windows. Procmon provides a convenient and efficient way for Linux developers to trace the syscall activity on the system.](https://github.com/Sysinternals/Procmon-for-Linux)
